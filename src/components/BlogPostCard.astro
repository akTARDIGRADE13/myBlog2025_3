---
import type { ImageMetadata } from 'astro';
import { Picture } from 'astro:assets';
import type { UnifiedPost } from '../types/post';

import default_eyecatch from '../assets/default-eyecatch.png';

interface Props {
    post: UnifiedPost;
}
const { post } = Astro.props as Props;

const dateObj = new Date(post.date);
const updatedObj = post.updated ? new Date(post.updated) : null;

const isZenn = post.source === "zenn";

const isImageMeta = (v: unknown): v is ImageMetadata =>
    !!v &&
    typeof v === "object" &&
    "src" in v &&
    "width" in v &&
    "height" in v &&
    "format" in v;

const rawEyecatch = post.eyecatch as unknown;
const chosenMeta: ImageMetadata = isImageMeta(rawEyecatch) ? rawEyecatch : default_eyecatch;
const stringUrl = typeof rawEyecatch === "string" ? rawEyecatch : undefined;

// âœ… Zennç”¨ã«ã€Œè¦‹ãŸç›®ã ã‘ã€å¤‰ãˆã‚‹ã‚¯ãƒ©ã‚¹
const cardClass = isZenn
    ? "border border-blue-400 bg-blue-50/40 rounded hover:shadow-lg hover:border-blue-500 transition"
    : "border p-4 rounded hover:shadow-lg transition";

// âœ… Zennã ã‘ â€œå¤–éƒ¨ãƒªãƒ³ã‚¯ã§ã‚ã‚‹â€ ã“ã¨ã‚’æ˜ç¤º
const linkTitle = isZenn ? "Zennã®è¨˜äº‹ã‚’å¤–éƒ¨ã‚µã‚¤ãƒˆã§é–‹ãã¾ã™" : undefined;

// âœ… ã‚¿ã‚°ã¯ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç¶­æŒã€‚Zennã¯ `zenn` ã ã‘ã ã¨å†—é•·ãªã®ã§éè¡¨ç¤ºã§ã‚‚OKï¼ˆä»»æ„ï¼‰
const displayTags = isZenn
    ? [] // â†ã€Œã‚¿ã‚°ä½ç½®ã¯ç¶­æŒã—ãŸã„ã€ãªã‚‰ [] ã®ã¾ã¾ã§â€œæ â€ã ã‘æ®‹ã•ãªã„ã‚ˆã†ã«ä¸‹ã®æç”»æ¡ä»¶ã«æ³¨æ„
    : (post.tags ?? []);
---

<li class={cardClass + " p-4"}>
    <a
        href={post.href}
        target={isZenn ? "_blank" : undefined}
        rel={isZenn ? "noopener noreferrer" : undefined}
        title={linkTitle}
        class="block"
    >
        <div class="flex flex-col md:flex-row gap-5">
            <!-- ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒç”»åƒé ˜åŸŸï¼ˆãã®ã¾ã¾ï¼‰ -->
            <div class="md:w-60 flex-none aspect-video relative overflow-hidden rounded">
                {isZenn ? (
                    <>
                        {/* èƒŒæ™¯ï¼ˆZennã®OGç”»åƒ or å˜è‰²ï¼‰ */}
                        {stringUrl ? (
                            <img
                                src={stringUrl}
                                alt=""
                                class="absolute inset-0 w-full h-full object-cover opacity-80"
                            />
                        ) : (
                            <div class="absolute inset-0 bg-blue-100" />
                        )}

                        {/* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆZennã£ã½ã•ã®æœ¬ä½“ï¼‰ */}
                        <div class="absolute inset-0 bg-blue-100/70" />

                        {/* ä¸­å¤®ã‚¢ã‚¤ã‚³ãƒ³ */}
                        <div class="absolute inset-0 flex items-center justify-center text-3xl text-blue-700">
                            ğŸ“–
                        </div>
                    </>
                ) : (
                    <>
                        {stringUrl ? (
                            <img
                                src={stringUrl}
                                alt={post.title}
                                loading="lazy"
                                decoding="async"
                                class="w-full h-full object-contain"
                            />
                        ) : (
                            <Picture
                                src={chosenMeta}
                                alt={post.title}
                                widths={[320, 480, 640]}
                                sizes="(max-width: 768px) 100vw, 240px"
                                formats={["avif", "webp"]}
                                fallbackFormat="png"
                                class="w-full h-full object-contain"
                            />
                        )}
                    </>
                )}
            </div>

            <!-- æ–‡ç« ã‚¨ãƒªã‚¢ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç¶­æŒï¼‰ -->
            <div class="md:w-96 flex flex-col h-full">
                <div class="flex items-start gap-2">
                    <h3 class="text-xl font-semibold">{post.title}</h3>

                    {/* Zennãƒãƒƒã‚¸ï¼ˆâ€œã‚¿ã‚°â€ã˜ã‚ƒãªãã‚½ãƒ¼ã‚¹è¡¨ç¤ºï¼‰ */}
                    {isZenn && (
                        <span class="mt-1 text-xs font-semibold px-2 py-0.5 rounded-full bg-blue-600 text-white">
                            Zenn
                        </span>
                    )}

                    {/* å¤–éƒ¨ãƒªãƒ³ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ */}
                    {isZenn && (
                        <span class="mt-1 text-sm text-blue-700" aria-hidden="true" title="å¤–éƒ¨ãƒªãƒ³ã‚¯">
                            â†—
                        </span>
                    )}
                </div>

                {/* Zennã ã‘çŸ­ã„æ³¨æ„æ›¸ãï¼ˆæ§ãˆã‚ï¼‰ */}
                {isZenn && (
                    <p class="mt-1 text-xs text-blue-700/80">
                        å¤–éƒ¨ã‚µã‚¤ãƒˆã§é–‹ãã¾ã™ï¼ˆzenn.devï¼‰
                    </p>
                )}

                <div class="mt-auto">
                    <p class="text-sm text-gray-400">
                        æŠ•ç¨¿æ—¥: {dateObj.toLocaleDateString('ja-JP')}
                    </p>

                    {updatedObj && updatedObj.getTime() !== dateObj.getTime() && (
                        <p class="text-sm text-gray-400">
                            æœ€çµ‚æ›´æ–°æ—¥: {updatedObj.toLocaleDateString('ja-JP')}
                        </p>
                    )}

                    {/* ã‚¿ã‚°ä½ç½®ã¯ãã®ã¾ã¾ã€‚Zennã¯ç©ºã«ã—ã¦ã‚‚OK */}
                    {displayTags.length > 0 && (
                        <div class="flex flex-wrap gap-2 mt-2">
                            {displayTags.map((tag) => (
                                <span class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-xs">
                                    {tag}
                                </span>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        </div>
    </a>
</li>
