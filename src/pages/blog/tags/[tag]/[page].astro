---
import Layout from "../../../../components/Layout/Layout.astro";
import BlogPostCard from "../../../../components/BlogPostCard.astro";
import Pagination from "../../../../components/Pagination.astro";
import TagList from "../../../../components/TagList.astro";

import { getMergedPosts } from "../../../../utils/posts";

const POSTS_PER_PAGE = 10;

// 各タグごとの 2ページ目以降を生成
export async function getStaticPaths() {
    const POSTS_PER_PAGE = 10;
    const posts = await getMergedPosts();

    const tagSet = new Set<string>();
    for (const post of posts) {
        for (const tag of post.tags ?? []) {
            tagSet.add(tag);
        }
    }

    const paths: { params: { tag: string; page: string } }[] = [];

    for (const tag of Array.from(tagSet)) {
        const filtered = posts.filter(post => (post.tags ?? []).includes(tag));
        const totalPages = Math.ceil(filtered.length / POSTS_PER_PAGE);
        // 1ページ目は index.astro で扱うので、2ページ目以降のみ生成
        if (totalPages > 1) {
            for (let i = 2; i <= totalPages; i++) {
                paths.push({ params: { tag, page: String(i) } });
            }
        }
    }
    return paths;
}

// URL パラメータ
const { tag, page } = Astro.params as { tag: string; page: string };
const currentPage = parseInt(page, 10);

// 全記事（local + zenn）
const posts = await getMergedPosts();

// タグで絞り込み
const filteredPosts = posts.filter(p => (p.tags ?? []).includes(tag));

const totalPages = Math.ceil(filteredPosts.length / POSTS_PER_PAGE);
const startIndex = (currentPage - 1) * POSTS_PER_PAGE;
const paginatedPosts = filteredPosts.slice(startIndex, startIndex + POSTS_PER_PAGE);
---

<Layout title={`タグ: ${tag}`} description={`タグ ${tag} の記事一覧`}>
    <section class="py-4">
        <TagList posts={posts} />

        <h2 class="text-3xl font-bold mb-4">
            タグ: {tag}（ページ {currentPage} / {totalPages}）
        </h2>

        <ul class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {paginatedPosts.map(post => <BlogPostCard post={post} />)}
        </ul>

        <Pagination
            currentPage={currentPage}
            totalPages={totalPages}
            basePath={`/blog/tags/${tag}`}
        />
    </section>
</Layout>
