---
import Layout from "../../../../components/Layout/Layout.astro";
import BlogPostCard from "../../../../components/BlogPostCard.astro";
import Pagination from "../../../../components/Pagination.astro";
import TagList from "../../../../components/TagList.astro";

import { getMergedPosts } from "../../../../utils/posts";

const POSTS_PER_PAGE = 10;

// getStaticPaths：全タグのパスを生成（1ページ目用）
export async function getStaticPaths() {
    const posts = await getMergedPosts();

    const tagSet = new Set<string>();
    for (const post of posts) {
        for (const tag of post.tags ?? []) {
            tagSet.add(tag);
        }
    }

    return Array.from(tagSet).map((tag) => ({
        params: { tag },
    }));
}

const posts = await getMergedPosts();

// 現在のタグ
const currentTag = Astro.params.tag as string;

// 指定タグの記事に絞り込み
const filteredPosts = posts.filter((post) => (post.tags ?? []).includes(currentTag));

const totalPages = Math.ceil(filteredPosts.length / POSTS_PER_PAGE);

// 1ページ目
const currentPage = 1;
const paginatedPosts = filteredPosts.slice(0, POSTS_PER_PAGE);
---

<Layout title={`タグ: ${currentTag}`} description={`タグ ${currentTag} の記事一覧`}>
    <section class="py-4">
        <TagList posts={posts} />

        <h2 class="text-3xl font-bold mb-4">
            タグ: {currentTag}（ページ {currentPage} / {totalPages}）
        </h2>

        <ul class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {paginatedPosts.map((post) => <BlogPostCard post={post} />)}
        </ul>

        <Pagination
            currentPage={currentPage}
            totalPages={totalPages}
            basePath={`/blog/tags/${currentTag}`}
        />
    </section>
</Layout>
