---
import Layout from '../../components/Layout/Layout.astro';
import BlogPostCard from '../../components/BlogPostCard.astro';
import Pagination from '../../components/Pagination.astro';
import TagList from '../../components/TagList.astro';

import { getMergedPosts } from '../../utils/posts';

const POSTS_PER_PAGE = 10;

// 2ページ目以降のルートを生成
export async function getStaticPaths() {
    const POSTS_PER_PAGE = 10;
    const posts = await getMergedPosts();
    const totalPages = Math.ceil(posts.length / POSTS_PER_PAGE);
    // ページ1 は index.astro で扱うため、ここでは 2 ページ目以降のみ生成
    return totalPages > 1
        ? Array.from({ length: totalPages - 1 }, (_, i) => ({
            params: { page: String(i + 2) }
        }))
        : [];
}

const posts = await getMergedPosts();
const totalPages = Math.ceil(posts.length / POSTS_PER_PAGE);

// Astro.params.page は必ず存在する前提（ページ2以降のみ）
const pageParam: string = Astro.params.page ?? "2";
const currentPage = parseInt(pageParam, 10);

const startIndex = (currentPage - 1) * POSTS_PER_PAGE;
const paginatedPosts = posts.slice(startIndex, startIndex + POSTS_PER_PAGE);
---

<Layout title="Blog" description="ブログ一覧">
    <section class="py-4">
        <TagList posts={posts} />

        <h2 class="text-3xl font-bold mb-4">
            記事一覧（ページ {currentPage} / {totalPages}）
        </h2>

        <ul class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {paginatedPosts.map(post => <BlogPostCard post={post} />)}
        </ul>

        <Pagination currentPage={currentPage} totalPages={totalPages} basePath="/blog" />
    </section>
</Layout>
